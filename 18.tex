% Быстрое вычисление суммы по любому отрезку и четырехвершиннику на изображении с помощью БПХ.

Рассмотрим изображение размера $N \times N, N = 2^n$ в оттенках серого. Известно, что для любой пары пикселей существует по крайней мере одна содержащая их диадическая прямая. При этом все такие прямые приближают отрезок между ними одинаковым образом, поэтому задача вычисления суммы по отрезку, заданному двумя концами при помощи преобразования Хафа как минимум корректно поставлена. Для ее решения требуется научиться находить параметры какой-либо диадической прямой, проходящей через эту пару точек и вычислять сумму по любому отрезку известной прямой.

Для определенности будем рассматривать только преимущественно горизонтальные отрезки с положительным наклоном, то есть такие, что $y_2 \ge y_1, x_2 \ge x_1, \Delta y \le \Delta x$, где $(x_1, y_1)$ и $(x_2, y_2)$ -- координаты концов отрезка.

\paragraph{Определение диадического паттерна.}
Известно, что любой диадический паттерн $y = I_p(x), p \in \{ 0, 1, \dots, N-1\}$ может быть представлен в виде суммы некоторого подмножества множества $D = \left\{ I_1(x), I_2(x), I_4(x), \dots, I_N(x) \right\}$, где под суммой паттернов понимается паттерн, описываемый уравнением $y = I_{p_1}(x) + I_{p_2}(x)$. Отметим, что нам достаточно подобрать любой паттерн, удовлетворяющий условию $I_p\left( x_2 \right) - I_p\left( x_1 \right) = y_2 - y_1$. Для этого применим жадный алгоритм: выберем в качестве начального приближения горизонтальный паттерн $I_0(x)$ и на каждом шаге будем прибавлять самый <<большой>> паттерн из множества $D$, который не приводит к переполнению, то есть при котором $I_p\left( x_2 \right) - I_p\left( x_1 \right) \le y_2 - y_1$. Данный алгоритм всегда приводит к решению, следовательно, после $O\left( \log N \right)$ операций мы получим параметр $t$, гарантирующий, что если паттерн проходит через первую точку, то он проходит и через вторую. Параметр $s$ подбирается очевидным способом так, чтобы паттерн действительно проходил через первую точку

\paragraph{Сумма по диадическому отрезку.}
Пусть задана диадическая прямая $y = s + I_t(x)$ и требуется вычислить сумму по всем точкам этой прямой на отрезке $0 \le x_1 \le x < x_2 \le N$.

Заметим, что для некоторых пар $(x_1, x_2)$ эта задача уже решается в процессе быстрого преобразования Хафа. А именно, на $k$-й итерации алгоритма в соответствующем массиве сохраняются такие суммы для всех $x_1 = m \cdot 2^k, x_2 = (m+1) \cdot 2^k$ по всем прямым. Несложно модифицировать алгоритм так, чтобы эти суммы были доступны после окончания вычислений, а не перезаписывались, для чего достаточно использовать для вычислений трехмерный массив. Это приведет к увеличению требований по памяти до $\Theta\left( N^2 \log N \right)$. При помощи этих значений сумма по любому отрезку с $x_1 = 0$ может быть вычислена при помощи жадного алгоритма, похожего на использованный в предыдущем пункте. Для произвольных значений $(x_1, x_2)$ следует вычислить сумму по двум отрезкам и взять разность. Итоговая сложность алгоритма составляет $\Theta\left( N^2 \log N \right)$ операций на предподсчет (БПХ), после чего сумма по каждому отрезку вычисляется за $O\left( \log N \right)$ операций.


Рассмотрим, как эта же методика может быть применена для вычисления сумм по произвольному выпуклому четырехвершиннику. Для этого применим к каждому столбцу кумулятивное суммирование так, чтобы каждый пиксель хранил сумму всех пикселей исходного изображения, расположенных в том же столбце не выше, чем он сам. Это преобразование выполняется линейным проходом по каждому столбцу за $\Theta\left( N^2 \right)$ операций. После такого преобразования сумма по произвольному отрезку фактически является суммой значений в исходном изображении по прямоугольной трапеции, одна из сторон которой обязательно находится на нижней строке изображения. Любой выпуклый четырехвершинник может быть представлен в виде суммы или разности не более чем четырех таких трапеций, следовательно, задача сводится к предыдущей и обладает такой же асимптотической сложностью: $\Theta\left( N^2 + N^2 \log N \right) = \Theta\left( N^2 \log N \right)$ операций на предподсчет и $O\left( 4 \log N \right) = O\left( \log N \right)$ операций на вычисление суммы по четырехвершиннику.
